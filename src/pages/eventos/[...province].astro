---
import { type CollectionEntry, getCollection, render } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import { slugify } from "../../utils";
import List from "../../components/List.astro";
import Filter from "../../components/Filter.astro";

export async function getStaticPaths() {
    const events = await getCollection("event");
    const provinces = new Set<string>();
    events.forEach((event: CollectionEntry<"event">) => {
        if (event.data.province) {
            provinces.add(event.data.province);
        }
    });
    return Array.from(provinces).map((province) => ({
        params: { province: slugify(province) },
        props: { province },
    }));
}

const { province } = Astro.props;

const events = await getCollection(
    "event",
    ({ data }) =>
        data.province && Astro.params.province.match(slugify(data.province)),
);

const future = events.filter((event) => event.data.start > new Date());
const past = events.filter((event) => event.data.start <= new Date());
---

<Layout>
    <Header />
    <main class="flex-1">
        <div
            class="relative flex items-end py-6 bg-primary bg-center bg-cover bg-no-repeat [clip-path:polygon(0_0,_100%_0,_100%_80%,_0%_100%)]"
        >
			<div class="w-full max-w-6xl mx-auto px-4 flex items-center justify-between">
                <h1 class="text-3xl md:text-5xl text-balance text-white">
                    Eventos en {province}
                </h1>
                <Filter />
            </div>
        </div>
        <section class="w-full max-w-6xl mx-auto px-4 py-6">
            <h2 class="text-3xl mb-4">
                Próximos eventos en {province}
            </h2>
            {
                future.length === 0 && (
                    <p class="text-gray-500">
                        No hay eventos próximos en {province}.
                    </p>
                )
            }
            <List events={future} />
            <h2 class="text-3xl mb-4 mt-12">
                Eventos pasados en {province}
            </h2>
            {
                past.length === 0 && (
                    <p class="text-gray-500">
                        No hay eventos pasados en {province}.
                    </p>
                )
            }
            <List events={past} />
        </section>
    </main>
    <Footer />
</Layout>
